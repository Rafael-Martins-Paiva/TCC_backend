
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Manage Menu</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
</head>
<body>
    <div class="container mt-5">
        <h1>Manage Menu for <span id="restaurant-name"></span></h1>
        <hr>

        <!-- Form for adding/editing menu items -->
        <div class="card mb-4">
            <div class="card-header">
                <h5 id="form-title">Add New Item</h5>
            </div>
            <div class="card-body">
                <form id="menu-item-form">
                    <input type="hidden" id="item-id">
                    <div class="mb-3">
                        <label for="item-name" class="form-label">Name</label>
                        <input type="text" class="form-control" id="item-name" required>
                    </div>
                    <div class="mb-3">
                        <label for="item-description" class="form-label">Description</label>
                        <textarea class="form-control" id="item-description" rows="3"></textarea>
                    </div>
                    <div class="mb-3">
                        <label for="item-price" class="form-label">Price</label>
                        <input type="number" class="form-control" id="item-price" step="0.01" required>
                    </div>
                    <div class="mb-3">
                        <label for="item-ingredients" class="form-label">Ingredients</label>
                        <textarea class="form-control" id="item-ingredients" rows="2" placeholder="e.g., flour, tomato, cheese"></textarea>
                    </div>
                    <div class="mb-3">
                        <label for="item-allergens" class="form-label">Allergens</label>
                        <textarea class="form-control" id="item-allergens" rows="2" placeholder="e.g., gluten, lactose, nuts"></textarea>
                    </div>
                    <button type="submit" class="btn btn-primary">Save Item</button>
                    <button type="button" class="btn btn-secondary" id="cancel-edit-btn" style="display: none;">Cancel Edit</button>
                </form>
            </div>
        </div>

        <!-- List of menu items -->
        <h2>Menu Items</h2>
        <div id="menu-items-list" class="row">
            <!-- Items will be dynamically inserted here -->
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', function () {
            const restaurantId = '{{ restaurant.id }}';
            const restaurantNameEl = document.getElementById('restaurant-name');
            const menuItemsListEl = document.getElementById('menu-items-list');
            const form = document.getElementById('menu-item-form');
            const formTitle = document.getElementById('form-title');
            const itemIdInput = document.getElementById('item-id');
            const itemNameInput = document.getElementById('item-name');
            const itemDescriptionInput = document.getElementById('item-description');
            const itemPriceInput = document.getElementById('item-price');
            const itemIngredientsInput = document.getElementById('item-ingredients');
            const itemAllergensInput = document.getElementById('item-allergens');
            const cancelEditBtn = document.getElementById('cancel-edit-btn');

            // Function to get CSRF token from cookies
            function getCookie(name) {
                let cookieValue = null;
                if (document.cookie && document.cookie !== '') {
                    const cookies = document.cookie.split(';');
                    for (let i = 0; i < cookies.length; i++) {
                        const cookie = cookies[i].trim();
                        if (cookie.substring(0, name.length + 1) === (name + '=')) {
                            cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                            break;
                        }
                    }
                }
                return cookieValue;
            }
            const csrftoken = getCookie('csrftoken');

            const apiHeaders = {
                'Content-Type': 'application/json',
                'X-CSRFToken': csrftoken
            };

            // Fetch restaurant details
            fetch(`/api/v1/restaurants/${restaurantId}/`)
                .then(response => response.json())
                .then(data => {
                    restaurantNameEl.textContent = data.name;
                    document.title = `Manage Menu for ${data.name}`;
                });

            // Function to render menu items
            function renderMenuItems(items) {
                menuItemsListEl.innerHTML = '';
                if (items.length === 0) {
                    menuItemsListEl.innerHTML = '<p class="text-muted">No menu items yet.</p>';
                    return;
                }
                items.forEach(item => {
                    const itemCard = `
                        <div class="col-md-4 mb-4">
                            <div class="card">
                                <div class="card-body">
                                    <h5 class="card-title">${item.name}</h5>
                                    <p class="card-text">${item.description}</p>
                                    <p class="card-text"><strong>Price:</strong> R$ ${item.price}</p>
                                    ${item.ingredients ? `<p class="card-text"><strong>Ingredients:</strong> ${item.ingredients}</p>` : ''}
                                    ${item.allergens ? `<p class="card-text"><strong>Allergens:</strong> ${item.allergens}</p>` : ''}
                                    <button class="btn btn-sm btn-primary edit-btn" data-id="${item.id}">Edit</button>
                                    <button class="btn btn-sm btn-danger delete-btn" data-id="${item.id}">Delete</button>
                                </div>
                            </div>
                        </div>
                    `;
                    menuItemsListEl.insertAdjacentHTML('beforeend', itemCard);
                });
            }

            // Function to fetch menu items
            function fetchMenuItems() {
                fetch(`/api/v1/restaurants/${restaurantId}/menu-items/`)
                    .then(response => response.json())
                    .then(data => {
                        renderMenuItems(data);
                    });
            }

            // Handle form submission (Create/Update)
            form.addEventListener('submit', function (e) {
                e.preventDefault();
                const itemId = itemIdInput.value;
                const url = itemId ? `/api/v1/restaurants/${restaurantId}/menu-items/${itemId}/` : `/api/v1/restaurants/${restaurantId}/menu-items/`;
                const method = itemId ? 'PUT' : 'POST';

                const formData = {
                    name: itemNameInput.value,
                    description: itemDescriptionInput.value,
                    price: itemPriceInput.value,
                    ingredients: itemIngredientsInput.value,
                    allergens: itemAllergensInput.value
                };

                fetch(url, {
                    method: method,
                    headers: apiHeaders,
                    body: JSON.stringify(formData)
                })
                .then(response => {
                    if (response.ok) {
                        fetchMenuItems();
                        resetForm();
                    } else {
                        alert('An error occurred. Please try again.');
                    }
                });
            });

            // Handle clicks on Edit and Delete buttons
            menuItemsListEl.addEventListener('click', function(e) {
                const target = e.target;
                const itemId = target.dataset.id;

                if (target.classList.contains('edit-btn')) {
                    // Fetch the single item's data to populate the form
                    fetch(`/api/v1/restaurants/${restaurantId}/menu-items/${itemId}/`)
                        .then(response => response.json())
                        .then(item => {
                            formTitle.textContent = 'Edit Item';
                            itemIdInput.value = item.id;
                            itemNameInput.value = item.name;
                            itemDescriptionInput.value = item.description;
                            itemPriceInput.value = item.price;
                            itemIngredientsInput.value = item.ingredients;
                            itemAllergensInput.value = item.allergens;
                            cancelEditBtn.style.display = 'inline-block';
                            window.scrollTo(0, 0); // Scroll to top to see the form
                        });
                }

                if (target.classList.contains('delete-btn')) {
                    if (confirm('Are you sure you want to delete this item?')) {
                        fetch(`/api/v1/restaurants/${restaurantId}/menu-items/${itemId}/`, {
                            method: 'DELETE',
                            headers: apiHeaders
                        })
                        .then(response => {
                            if (response.ok) {
                                fetchMenuItems();
                            } else {
                                alert('An error occurred during deletion.');
                            }
                        });
                    }
                }
            });

            // Handle Cancel Edit button
            cancelEditBtn.addEventListener('click', resetForm);

            function resetForm() {
                form.reset();
                formTitle.textContent = 'Add New Item';
                itemIdInput.value = '';
                cancelEditBtn.style.display = 'none';
            }

            // Initial fetch
            fetchMenuItems();
        });
    </script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
