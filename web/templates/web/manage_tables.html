<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Manage Tables for {{ restaurant.name }}</title>
    <style>
        body { font-family: sans-serif; margin: 20px; }
        .container { max-width: 900px; margin: auto; }
        .section { margin-bottom: 30px; padding: 20px; border: 1px solid #eee; border-radius: 5px; }
        h1, h2 { color: #333; }
        input[type="text"], input[type="number"], select {
            width: 100%; padding: 8px; margin: 5px 0 15px 0; display: inline-block; border: 1px solid #ccc; border-radius: 4px; box-sizing: border-box;
        }
        button {
            background-color: #4CAF50; color: white; padding: 10px 15px; border: none; border-radius: 4px; cursor: pointer; margin-right: 10px;
        }
        button:hover { background-color: #45a049; }
        .error { color: red; margin-bottom: 10px; }
        .success { color: green; margin-bottom: 10px; }
        .table-item { border: 1px solid #ddd; padding: 10px; margin-bottom: 10px; border-radius: 4px; }
        .table-item button { background-color: #f44336; }
        .table-item button:hover { background-color: #da190b; }
    </style>
</head>
<body>
    <div class="container">
        <h1>Manage Tables for {{ restaurant.name }}</h1>

        <div id="messages"></div>

        <div class="section">
            <h2>Your Restaurant Tables</h2>
            <div id="table-list">
                <!-- Tables will be loaded here -->
            </div>

            <h2>Create New Table</h2>
            <form id="create-table-form">
                <label for="create-table-number">Table Number:</label>
                <input type="text" id="create-table-number" name="table_number" required>

                <label for="create-capacity">Capacity:</label>
                <input type="number" id="create-capacity" name="capacity" required>

                <label for="create-status">Status:</label>
                <select id="create-status" name="status">
                    <option value="available">Available</option>
                    <option value="occupied">Occupied</option>
                    <option value="reserved">Reserved</option>
                    <option value="needs_cleaning">Needs Cleaning</option>
                </select>

                <button type="submit">Create Table</button>
            </form>

            <h2>Edit Table</h2>
            <form id="edit-table-form" style="display: none;">
                <input type="hidden" id="edit-table-id">
                <label for="edit-table-number">Table Number:</label>
                <input type="text" id="edit-table-number" name="table_number" disabled>

                <label for="edit-capacity">Capacity:</label>
                <input type="number" id="edit-capacity" name="capacity" required>

                <label for="edit-status">Status:</label>
                <select id="edit-status" name="status">
                    <option value="available">Available</option>
                    <option value="occupied">Occupied</option>
                    <option value="reserved">Reserved</option>
                    <option value="needs_cleaning">Needs Cleaning</option>
                </select>

                <button type="submit">Save Changes</button>
                <button type="button" id="cancel-edit">Cancel</button>
            </form>
        </div>
    </div>

    <script>
        const API_BASE_URL = '/api/v1/';
        const restaurantId = '{{ restaurant.id }}'; // Get restaurant ID from Django context
        const messagesDiv = document.getElementById('messages');
        const tableListDiv = document.getElementById('table-list');
        const createTableForm = document.getElementById('create-table-form');
        const editTableForm = document.getElementById('edit-table-form');
        const editTableIdInput = document.getElementById('edit-table-id');
        const editTableNumberInput = document.getElementById('edit-table-number');
        const editCapacityInput = document.getElementById('edit-capacity');
        const editStatusSelect = document.getElementById('edit-status');
        const cancelEditButton = document.getElementById('cancel-edit');

        // TODO: Implement a way to get the JWT token for authenticated API calls.
        // For now, you might need to manually paste a token here for testing.
        let authToken = localStorage.getItem('authToken'); // Attempt to get from local storage

        

        function showMessage(message, type = 'success') {
            messagesDiv.innerHTML = `<div class="${type}">${message}</div>`;
            setTimeout(() => messagesDiv.innerHTML = '', 5000);
        }

        async function apiCall(endpoint, method = 'GET', data = null) {
            const headers = {
                'Content-Type': 'application/json',
            };
            // For Django session authentication, we need to include the CSRF token
            const csrftokenCookie = document.cookie.split('; ').find(row => row.startsWith('csrftoken='));
            if (csrftokenCookie) {
                const csrftoken = csrftokenCookie.split('=')[1];
                headers['X-CSRFToken'] = csrftoken;
            }

            if (authToken) {
                headers['Authorization'] = `Bearer ${authToken}`;
            }

            const config = {
                method: method,
                headers: headers,
            };

            if (data) {
                config.body = JSON.stringify(data);
            }

            try {
                const response = await fetch(`${API_BASE_URL}${endpoint}`, config);
                if (!response.ok) {
                    if (response.status === 401) {
                        // Unauthorized: token is invalid or expired
                        localStorage.removeItem('authToken');
                        authToken = null;
                        showMessage('Authentication failed. Your token was invalid. Please log in again.', 'error');
                        // Optional: redirect to a login page
                        // window.location.href = '/your-login-page/'; 
                        throw new Error('Authentication failed. Please log in again.');
                    }
                    const errorData = await response.json();
                    throw new Error(errorData.detail || JSON.stringify(errorData));
                }
                // For DELETE, response might be empty
                if (response.status === 204) return {};
                return await response.json();
            } catch (error) {
                showMessage(`API Error: ${error.message}`, 'error');
                throw error;
            }
        }

        async function loadTables() {
            try {
                // The API endpoint for tables already filters by the user's restaurant.
                // So, we don't need to pass restaurantId in the URL for listing.
                const tables = await apiCall('tables/');
                tableListDiv.innerHTML = '';
                if (tables.length === 0) {
                    tableListDiv.innerHTML = '<p>No tables found for this restaurant.</p>';
                    return;
                }
                tables.forEach(table => {
                    const tableItem = document.createElement('div');
                    tableItem.className = 'table-item';
                    tableItem.innerHTML = `
                        <h3>Table ${table.table_number}</h3>
                        <p>Capacity: ${table.capacity}</p>
                        <p>Status: ${table.status}</p>
                        <p>QR Code: <a href="${table.qr_code_url}" target="_blank">View QR Code</a></p>
                        <button onclick="editTable('${table.id}', '${table.table_number}', ${table.capacity}, '${table.status}')">Edit</button>
                        <button onclick="deleteTable('${table.id}')">Delete</button>
                    `;
                    tableListDiv.appendChild(tableItem);
                });
            } catch (error) {
                console.error('Failed to load tables:', error);
            }
        }

        async function createTable(event) {
            event.preventDefault();
            const formData = new FormData(createTableForm);
            const data = Object.fromEntries(formData.entries());
            data.restaurant = restaurantId; // Add the restaurant ID to the data

            try {
                await apiCall('tables/', 'POST', data);
                showMessage('Table created successfully!');
                createTableForm.reset();
                loadTables();
            } catch (error) {
                console.error('Failed to create table:', error);
            }
        }

        function editTable(id, table_number, capacity, status) {
            editTableIdInput.value = id;
            editTableNumberInput.value = table_number;
            editCapacityInput.value = capacity;
            editStatusSelect.value = status;
            editTableForm.style.display = 'block';
            window.scrollTo(0, document.body.scrollHeight); // Scroll to edit form
        }

        async function saveTableChanges(event) {
            event.preventDefault();
            const tableId = editTableIdInput.value;
            const data = {
                capacity: parseInt(editCapacityInput.value),
                status: editStatusSelect.value,
            };

            try {
                await apiCall(`tables/${tableId}/`, 'PATCH', data);
                showMessage('Table updated successfully!');
                editTableForm.style.display = 'none';
                loadTables();
            } catch (error) {
                console.error('Failed to update table:', error);
            }
        }

        async function deleteTable(id) {
            if (!confirm('Are you sure you want to delete this table?')) {
                return;
            }
            try {
                await apiCall(`tables/${id}/`, 'DELETE');
                showMessage('Table deleted successfully!');
                loadTables();
            } catch (error) {
                console.error('Failed to delete table:', error);
            }
        }

        // Event Listeners
        createTableForm.addEventListener('submit', createTable);
        editTableForm.addEventListener('submit', saveTableChanges);
        cancelEditButton.addEventListener('click', () => {
            editTableForm.style.display = 'none';
        });

        // Initial load
        if (authToken) {
            loadTables();
        } else {
            showMessage('No authentication token found. Please log in to manage tables.', 'error');
        }
    </script>
</body>
</html>
